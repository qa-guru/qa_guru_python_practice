# Часть 3. XPath (руководство с синтаксисом)

XPath (XML Path Language) — это язык запросов, который используется для поиска элементов в HTML- и XML-документах.
В автоматизации тестирования XPath применяют тогда, когда требуется поиск по тексту, навигация по структуре DOM или составление сложных логических условий.
Он поддерживается всеми основными инструментами — Selenium, Playwright, Cypress и другими.

Поиск по XPath основан на восприятии HTML как иерархического дерева узлов.
XPath позволяет находить элементы, опираясь на:
 - их положение в структуре документа;
 - значения атрибутов;
 - содержимое текста;
 - связи между элементами (родитель, потомок, сосед);
 - сочетание нескольких логических условий.

В отличие от CSS-селекторов, которые выбирают элементы по правилам, аналогичным применению стилей, XPath предоставляет полноценный механизм навигации по DOM-дереву. Поэтому он особенно полезен, когда требуется учитывать относительное расположение элементов или работать с текстовыми узлами.

---

## Типы XPath

| Тип | Пример | Описание |
|-----|---------|-----------|
| Абсолютный | `/html/body/div[1]/form/input[1]` | Путь от корня документа. Хрупок при любом изменении структуры. |
| Относительный | `//input[@id='login']` | Поиск от любого места в DOM. Гибкий и устойчивый. |

**Рекомендация:** в автотестах используйте только относительный XPath.

## Базовый синтаксис XPath

| Синтаксис | Описание | Пример |
|-----------|----------|---------|
| `//tag` | Все элементы с указанным тегом | `//input` |
| `//tag[@attr='value']` | Элемент с атрибутом | `//button[@id='submit']` |
| `//*[@attr='value']` | Любой элемент с атрибутом | `//*[@name='email']` |
| `//tag[text()='value']` | Элемент по точному тексту | `//button[text()='Login']` |
| `//tag[contains(text(),'value')]` | Частичное совпадение текста | `//div[contains(text(),'error')]` |

---

## Поиск по атрибутам

| Вид | Пример | Найдёт |
|------|---------|---------|
| Точное совпадение | `//input[@name='username']` | Поле с атрибутом `name="username"` |
| Частичное совпадение | `//a[contains(@href, 'login')]` | Ссылка, где `href` содержит `login` |
| Начало значения | `//div[starts-with(@class,'header')]` | Класс начинается с `header` |
| Конец значения | `//img[ends-with(@src, '.png')]` | `src` заканчивается на `.png` *(в XPath 1.0 функция ends-with недоступна)* |

---

## Поиск по тексту

| Селектор | Пример | Описание |
|----------|---------|----------|
| `text()` | `//a[text()='Home']` | Полное совпадение текста |
| `contains(text(),'...')` | `//a[contains(text(),'Sign')]` | Частичное совпадение |
| `normalize-space()` | `//button[normalize-space()='Submit']` | Убирает лишние пробелы |
| `starts-with(text(),'...')` | `//p[starts-with(text(),'Hello')]` | Текст начинается с указанного значения |

---

## Навигация по DOM
XPath позволяет перемещаться между родителями, предками, потомками и соседями.

| Оператор | Описание | Пример |
|----------|----------|---------|
| `/` | Прямой потомок | `/html/body/div` |
| `//` | Потомок любого уровня | `//div//input` |
| `..` | Родитель | `//input[@id='login']/..` |
| `@` | Доступ к атрибуту | `//input[@name='email']/@type` |
| `.` | Текущий элемент | `//div[@class='content']/.` |

---

## Оси (Axes)
Оси позволяют двигаться в любую сторону по структуре DOM.

| Ось | Описание | Пример |
|------|----------|---------|
| `parent::` | Родитель | `//input[@id='email']/parent::div` |
| `child::` | Дочерние элементы | `//div[@class='form']/child::input` |
| `ancestor::` | Любой предок | `//input[@id='email']/ancestor::form` |
| `descendant::` | Любой потомок | `//form[@id='login']/descendant::input` |
| `following::` | Элементы после текущего | `//h2/following::p` |
| `preceding::` | Элементы перед текущим | `//p/preceding::h2` |
| `following-sibling::` | Сосед справа | `//label/following-sibling::input` |
| `preceding-sibling::` | Сосед слева | `//input/preceding-sibling::label` |

---

## Индексы и позиции

| Селектор | Пример | Найдёт |
|----------|---------|---------|
| `[1]` | `(//input)[1]` | Первый элемент |
| `[last()]` | `(//div)[last()]` | Последний элемент |
| `[position()=3]` | `(//li)[position()=3]` | Третий элемент |
| `[position()<4]` | `(//li)[position()<4]` | Первые три элемента |

---

## Примеры множественных условий

### 
```xpath
//input[@type='text' and @name='email']
//button[@type='submit' or @name='login']
//div[@class='error' and contains(text(),'Invalid')]
//button[@type='submit' and text()='Login']
```

---

## contains() и not()

| Синтаксис | Пример | Описание |
|-----------|---------|-----------|
| `contains()` | `//div[contains(@class, 'active')]` | Частичное совпадение |
| `not()` | `//input[not(@type='hidden')]` | Исключение |
| `and` / `or` | `//a[@href and @title]` | Оба атрибута присутствуют |

---

## Примеры комбинированных локаторов

### 
```xpath
//div[@data-qa='product-card']//button[contains(normalize-space(), 'Добавить')]
//*[normalize-space()='Сохранить' and @data-qa='save']
//tr[td='SKU-42']/td[@data-col='price']
//div[@role='dialog' and not(@aria-hidden='true')]//button[@type='submit']
```
---
## Мини-шпаргалка XPath

| Цель | XPath |
|------|--------|
| Поиск по тегу | `//div` |
| По id | `//*[@id='login']` |
| По классу | `//*[@class='btn']` |
| По атрибуту | `//*[@attr='value']` |
| По тексту | `//*[text()='Login']` *(работает только при прямом тексте)* |
| Частичное совпадение | `//*[contains(text(),'Log')]` |
| Начало значения | `//*[starts-with(@id,'user')]` |
| Исключение | `//*[not(@disabled)]` |
| Родитель | `//input/..` |
| Сосед справа | `//label/following-sibling::input` |
| Первый элемент | `(//div)[1]` |
| Последний элемент | `(//div)[last()]` |

